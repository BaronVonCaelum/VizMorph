<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VizMorph</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            padding: 20px;
            min-height: 100vh;
        }
        
        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .app-header h1 {
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .app-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin: 20px auto;
            max-width: 900px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8ebff);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #e8ebff, #f8f9ff);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-area h4 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .suggestion-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .suggestion-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .suggestion-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px 20px;
        }
        
        .confidence-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .improvement-list {
            list-style: none;
            padding-left: 0;
        }
        
        .improvement-list li {
            padding: 5px 0;
            border-left: 3px solid #667eea;
            padding-left: 15px;
            margin-bottom: 5px;
        }
        
        .preview-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .loading i {
            font-size: 3rem;
            color: #667eea;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .workbook-summary {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: #28a745;
        }
        
        .status-warning {
            background: #ffc107;
        }
        
        .status-info {
            background: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="app-header">
            <h1><i class="fas fa-chart-line"></i> VizMorph</h1>
            <p>Transform your Tableau visualizations with intelligent suggestions</p>
        </div>
        
        <div class="content-card">
            <div id="upload-section">
                <div class="upload-area" onclick="selectFile()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Upload Tableau Workbook</h4>
                    <p>Click here to select a .twb or .twbx file, or use File â†’ Open Tableau Workbook</p>
                    <button class="btn btn-custom">
                        <i class="fas fa-folder-open"></i> Choose File
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".twb,.twbx" style="display: none;" onchange="handleFileSelect(this)">
            </div>
            
            <div id="result-section" style="display: none;"></div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const { ipcRenderer } = require('electron');
        
        let currentWorkbookId = null;

        // Handle file selection from menu
        ipcRenderer.on('file-selected', (event, filePath) => {
            uploadWorkbook(filePath);
        });

        function selectFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const filePath = input.files[0].path;
                uploadWorkbook(filePath);
            }
        }

        async function uploadWorkbook(filePath) {
            showLoading('Uploading and parsing workbook...');
            
            try {
                const result = await ipcRenderer.invoke('upload-workbook', filePath);
                
                if (result.success) {
                    currentWorkbookId = result.workbook_id;
                    showWorkbookSummary(result);
                } else {
                    showError('Upload failed: ' + result.error);
                }
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        async function getSuggestions() {
            if (!currentWorkbookId) return;
            
            showLoading('Generating visualization suggestions...');
            
            try {
                const result = await ipcRenderer.invoke('get-suggestions', currentWorkbookId);
                
                if (result.success) {
                    showSuggestions(result.suggestions);
                } else {
                    showError('Failed to get suggestions: ' + result.error);
                }
            } catch (error) {
                showError('Failed to get suggestions: ' + error.message);
            }
        }

        async function previewVisualization(suggestionId) {
            showLoading('Generating visualization preview...');
            
            try {
                const result = await ipcRenderer.invoke('preview-visualization', suggestionId);
                
                if (result.success) {
                    showPreview(result.config, suggestionId);
                } else {
                    showError('Failed to generate preview: ' + result.error);
                }
            } catch (error) {
                showError('Failed to generate preview: ' + error.message);
            }
        }

        async function exportVisualization(suggestionId, format) {
            try {
                const result = await ipcRenderer.invoke('export-visualization', suggestionId, format);
                
                if (result.success) {
                    // Handle the export result (could save to file, show in new window, etc.)
                    console.log('Export successful:', result.data);
                    alert(`Visualization exported as ${format.toUpperCase()}`);
                } else {
                    showError('Failed to export: ' + result.error);
                }
            } catch (error) {
                showError('Failed to export: ' + error.message);
            }
        }

        function showLoading(message) {
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('result-section').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <h4>${message}</h4>
                </div>
            `;
        }

        function showWorkbookSummary(data) {
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('result-section').innerHTML = `
                <div class="workbook-summary">
                    <h4><i class="fas fa-file-alt"></i> Workbook Loaded Successfully</h4>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> ${data.summary.name}</p>
                            <p><strong>Version:</strong> ${data.summary.version}</p>
                        </div>
                        <div class="col-md-6">
                            <p><span class="status-indicator status-success"></span><strong>Worksheets:</strong> ${data.summary.worksheet_count}</p>
                            <p><span class="status-indicator status-info"></span><strong>Dashboards:</strong> ${data.summary.dashboard_count}</p>
                            <p><span class="status-indicator status-warning"></span><strong>Stories:</strong> ${data.summary.story_count}</p>
                        </div>
                    </div>
                    <button class="btn btn-light mt-3" onclick="getSuggestions()">
                        <i class="fas fa-magic"></i> Generate Suggestions
                    </button>
                </div>
            `;
        }

        function showSuggestions(suggestions) {
            if (suggestions.length === 0) {
                document.getElementById('result-section').innerHTML = `
                    <div class="alert alert-info">
                        <h4><i class="fas fa-info-circle"></i> No Suggestions</h4>
                        <p>No alternative visualization suggestions were generated for this workbook.</p>
                    </div>
                `;
                return;
            }

            const suggestionsHtml = suggestions.map(suggestion => `
                <div class="suggestion-card card">
                    <div class="suggestion-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${suggestion.title}</h5>
                            <span class="confidence-badge">
                                ${Math.round(suggestion.confidence * 100)}% confidence
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${suggestion.description}</p>
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-lightbulb"></i> Why this suggestion?</h6>
                                <p class="text-muted">${suggestion.rationale}</p>
                                
                                <h6><i class="fas fa-arrow-up"></i> Improvements</h6>
                                <ul class="improvement-list">
                                    ${suggestion.improvements.map(imp => `<li>${imp}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-cog"></i> Actions</h6>
                                <button class="btn btn-custom btn-sm mb-2 btn-block" onclick="previewVisualization('${suggestion.id}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle btn-block" type="button" data-toggle="dropdown">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="exportVisualization('${suggestion.id}', 'json')">JSON</a>
                                        <a class="dropdown-item" href="#" onclick="exportVisualization('${suggestion.id}', 'd3')">D3.js</a>
                                        <a class="dropdown-item" href="#" onclick="exportVisualization('${suggestion.id}', 'vega-lite')">Vega-Lite</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('result-section').innerHTML = `
                <h4><i class="fas fa-chart-bar"></i> Visualization Suggestions</h4>
                <p class="text-muted">Found ${suggestions.length} alternative visualization${suggestions.length !== 1 ? 's' : ''} for your workbook.</p>
                ${suggestionsHtml}
            `;
        }

        function showPreview(config, suggestionId) {
            const configJson = JSON.stringify(config, null, 2);
            
            document.getElementById('result-section').innerHTML = `
                <h4><i class="fas fa-eye"></i> Visualization Preview</h4>
                <div class="preview-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>${config.title || 'Visualization Preview'}</h5>
                        <button class="btn btn-secondary btn-sm" onclick="getSuggestions()">
                            <i class="fas fa-arrow-left"></i> Back to Suggestions
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Configuration</h6>
                            <pre style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 5px;">${configJson}</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Visualization</h6>
                            <div id="viz-preview" style="background: white; padding: 15px; border-radius: 5px; min-height: 400px;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-line fa-3x"></i>
                                    <p class="mt-3">D3.js visualization would render here</p>
                                    <p class="small">Full implementation would create interactive ${config.type} chart</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-custom" onclick="exportVisualization('${suggestionId}', 'd3')">
                            <i class="fas fa-code"></i> Get D3.js Code
                        </button>
                        <button class="btn btn-outline-primary ml-2" onclick="exportVisualization('${suggestionId}', 'vega-lite')">
                            <i class="fas fa-file-code"></i> Get Vega-Lite Spec
                        </button>
                    </div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('result-section').innerHTML = `
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                    <p>${message}</p>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
